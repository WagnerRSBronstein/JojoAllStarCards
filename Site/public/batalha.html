<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <title>Batalha de Cartas - Batalha</title>
  <link rel="stylesheet" href="css/battle_selection.css">
  <link rel="icon" type="image/png" href="assets/logo.png">
</head>

<body>
  <h1>Batalha de Cartas - JoJo Edition</h1>

  <div id="tela_batalha">
    <div id="area_cartas">
      <div class="card" id="card_jogador">
        <h3>Voc√™</h3>
        <img id="img_jogador" src="">
        <p id="vida_jogador">üíô Vida: 100</p>
      </div>

      <div class="card" id="card_inimigo">
        <h3>Inimigo</h3>
        <img id="img_inimigo" src="">
        <p id="vida_inimigo">üíÄ Vida: 100</p>
      </div>
    </div>

    <br>
    <p>Escolha seu golpe:</p>
    <div id="botoes_ataque"></div>
  </div>

  <div id="div_mensagem"></div>

  <script src="personagens.js"></script>
  <script>
    // --- configura√ß√£o b√°sica ---
    var vidaMax = 100;

    var vidaJogador = vidaMax;
    var vidaPC = vidaMax;
    var cartaJogador = 0;
    var cartaPC = 0;
    var rodada = 1;
    var paralisePC = 0;
    var cooldownHabilidade3 = 0;
    var cooldownValentine1 = 0; // cooldown da habilidade 1 do Valentine
    var cooldownKira = 0; // cooldown da habilidade 3 do Kira
    var epitaphAtivo = false;
    var bloqueioHabilidadesPC = 0;
    var buffAtaque = 0;

    // Obt√©m a carta selecionada via query string
    function getQueryParam(name) { //extrair o valor de um par√¢metro de string de consulta a partir de uma URL.
      var params = new URLSearchParams(window.location.search);
      return params.get(name);
    }
    
    var idBatalha = 0;
    var idUsuario = sessionStorage.ID_USUARIO;
    var danoTotal = 0;

    function iniciar() {
      checarID();
      var q = getQueryParam('c');
      cartaJogador = q ? Number(q) : 1;
      cartaPC = Math.floor(Math.random() * 9) + 1;
      vidaJogador = vidaMax;
      vidaPC = vidaMax;
      rodada = 1;
      paralisePC = 0;
      cooldownHabilidade3 = 3;
      cooldownValentine1 = 0;
      cooldownKira = 0;
      epitaphAtivo = false;
      bloqueioHabilidadesPC = 0;
      buffAtaque = 0;

      img_jogador.src = imagemCarta(cartaJogador);
      img_inimigo.src = imagemCarta(cartaPC);

      atualizarVida();
      gerarBotoes();

      div_mensagem.innerHTML = "<p>Voc√™ escolheu <b>" + nomeCarta(cartaJogador) + "</b> e o inimigo escolheu <b>" + nomeCarta(cartaPC) + "</b>.</p><p>Comece atacando!</p>";
    }

    function checarID(){
      fetch("/batalha/checarID", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                idUsuarioServer: idUsuario

            }),

        })
            .then(function (resposta) {
                if (resposta.ok) {
                    resposta.json().then(json => {
                      console.log(json);
                      sessionStorage.ID_BATALHA = json.batalha,
                      idBatalha = sessionStorage.ID_BATALHA
                    })
                    
                } else {
                    throw 'Houve um erro ao obter o ID!'
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`)
            })

    }

    function gerarBotoes() {
      var botoes = "";
      var lista = golpes[cartaJogador] || [];

      for (var i = 0; i < lista.length; i++) {
        let disabled = false;
        let title = "";

        if (i === 2 && cooldownHabilidade3 > 0) { disabled = true; title = "Recarga: " + cooldownHabilidade3 + " rodada(s) restante(s)"; }
        if (cartaJogador === 9 && i === 0 && cooldownValentine1 > 0) { disabled = true; title = "Recarga: " + cooldownValentine1 + " rodada(s) restante(s)"; }
        if (cartaJogador === 2 && i === 0 && cooldownKira > 0) { disabled = true; title = "Recarga: " + cooldownKira + " rodada(s) restante(s)"; }

        botoes += `<button ${disabled ? "disabled title='" + title + "'" : "onclick='atacar(" + i + ")'"}>${lista[i].nome}${disabled ? " (‚è≥)" : ""}</button>`;
      }

      botoes_ataque.innerHTML = botoes;
    }

    function atacar(indiceGolpe) {
      var texto = "";
      var listaGolpes = golpes[cartaJogador] || [];
      var golpe = listaGolpes[indiceGolpe];

      if (!golpe) return;

      if (vidaJogador > 0 && vidaPC > 0) {
        if (golpe.dano) {
          var danoFinal = golpe.dano + buffAtaque;
          danoTotal += danoFinal;
          var limiar = vidaMax * 0.4;
          if (golpe.execute) {
            if (vidaPC < limiar || (vidaPC - danoFinal) < limiar) {
              vidaPC = 0;
              texto = golpe.nome + "</b> executou o inimigo (menos de 40% detectado)!";
            } else {
              vidaPC -= danoFinal;
              texto = "Voc√™ usou <b>" + golpe.nome + "</b>! (-" + danoFinal + " de vida inimiga)";
            }
          } else {
            vidaPC -= danoFinal;
            console.log(danoTotal);
            texto = "Voc√™ usou <b>" + golpe.nome + "</b>! (-" + danoFinal + " de vida inimiga)";
          }
        }

        if (golpe.cura_inimigo) {
          vidaPC = Math.min(vidaMax, vidaPC + golpe.cura_inimigo);
          texto += "<br> Crazy Diamond restaurou o inimigo! (+ " + golpe.cura_inimigo + " vida)";
        }

        if (golpe.buff) { buffAtaque += 5; texto += "<br> Seu poder aumentou! (+5 de dano nos pr√≥ximos ataques)"; }
        if (golpe.cura) { vidaJogador = Math.min(vidaMax, vidaJogador + golpe.cura); texto += "<br> Voc√™ se curou +" + golpe.cura + "!"; }
        if (golpe.cura_total) { vidaJogador = vidaPC = vidaMax; texto += "<br>'Bites the Dust' ativou! Ambos voltaram √† vida cheia!"; }
        if (golpe.epitaph) { epitaphAtivo = true; var cardJog = document.getElementById("card_jogador"); if (cardJog) cardJog.classList.add("epitaph-ativo"); texto += "<br> Voc√™ ativou <b>Epitaph</b>! O pr√≥ximo ataque inimigo ser√° anulado!"; }
        if (golpe.paralisa) { paralisePC = golpe.paralisa; texto += "<br> O inimigo est√° paralisado por " + golpe.paralisa + " rodada(s)!"; }
        if (golpe.trava) { bloqueioHabilidadesPC = 3; var cardJog = document.getElementById("card_jogador"); if (cardJog) cardJog.classList.add("whitesnake-ativo"); texto += "<br> White Snake roubou os discos do inimigo por 3 rodadas!"; }

        if (indiceGolpe === 2) cooldownHabilidade3 = 3;
        if (cartaJogador === 9 && indiceGolpe === 0) cooldownValentine1 = 3;
        if (cartaJogador === 2 && indiceGolpe === 3) cooldownKira = 5;

        if (vidaPC > 0) {
          if (bloqueioHabilidadesPC > 0) {
            texto += "<br> O inimigo est√° sob efeito de White Snake e n√£o pode agir!";
            bloqueioHabilidadesPC--;
            var cardJog2 = document.getElementById("card_jogador");
            if (cardJog2) cardJog2.classList.remove("whitesnake-ativo");
          } else if (paralisePC > 0) {
            texto += "<br>O inimigo est√° paralisado e n√£o pode agir nesta rodada!";
            paralisePC--;
          } else {
            var listaPC = golpes[cartaPC] || [];
            var golpePC = listaPC[Math.floor(Math.random() * listaPC.length)];

            if (golpePC) {
              if (epitaphAtivo) {
                texto += "<br> O Epitaph previu o ataque inimigo! Nenhum dano recebido!";
                epitaphAtivo = false;
                var cardJog3 = document.getElementById("card_jogador");
                if (cardJog3) cardJog3.classList.remove("epitaph-ativo");
              } else {
                if (golpePC.dano) { vidaJogador -= golpePC.dano; texto += "<br>O inimigo usou <b>" + golpePC.nome + "</b> (-" + golpePC.dano + ")"; }
                if (golpePC.cura) { vidaPC = Math.min(vidaMax, vidaPC + golpePC.cura); texto += "<br>O inimigo se curou +" + golpePC.cura + "!"; }
                if (golpePC.cura_total) { vidaJogador = vidaPC = vidaMax; texto += "<br> Cura total ativada pelo inimigo! Ambos voltaram √† vida cheia!"; }
              }
            }
          }
        }

        if (vidaJogador <= 0 || vidaPC <= 0) {
          var fim = "";
          var batalhaAtual = 0;

          if(idBatalha == "undefined" || idBatalha == "null" || idBatalha == "NaN"){
            batalhaAtual++
          }else {
            batalhaAtual = Number(idBatalha) + 1;
          }
          console.log(batalhaAtual, idBatalha)
          fetch('/batalha/registrarBatalha', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                danoServer: danoTotal,
                idUsuarioServer: idUsuario,
                batalhaAtualServer: batalhaAtual

            }),

        })
            .then(function (resposta) {
                if (resposta.ok) {
                    
                    console.log("KONO DIO DA")
                } else {
                    console.error("MUDA MUDA MUDA")
                    throw 'Houve um erro ao tentar realizar o cadastro!'
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`)
            })

          if (vidaPC <= 0 && vidaJogador > 0) fim = "Voc√™ venceu a batalha!";
          else if (vidaJogador <= 0 && vidaPC > 0) fim = " Voc√™ foi derrotado!";
          else fim = " Empate! Ambos ca√≠ram.";

          div_mensagem.innerHTML = "<h2>" + fim + "</h2><button onclick='voltar()'>Voltar ao In√≠cio</button> <button onclick='reiniciar()'>Jogar Novamente</button> <button onclick='detalhar()'>Mais detalhes da partida</button>";
        } else {
          rodada++;
          if (cooldownHabilidade3 > 0) cooldownHabilidade3--;
          if (cooldownValentine1 > 0) cooldownValentine1--;
          if (cooldownKira > 0) cooldownKira--;
          gerarBotoes();
          div_mensagem.innerHTML = texto;
        }atualizarVida();
      }
    }

    function atualizarVida() {
      vida_jogador.innerHTML = "üíô Vida: " + Math.max(0, Math.round(vidaJogador));
      vida_inimigo.innerHTML = "üíÄ Vida: " + Math.max(0, Math.round(vidaPC));
    }

    function reiniciar() {
      // reinicia a batalha com mesma carta escolhida
      iniciar();
      checarID();
      danoTotal = 0;
    }

    function voltar() {
      location.href = 'selecao.html';
    }
    function detalhar(){
      location.href = './dashboard/dashboard.html';
    }

    // inicia automaticamente quando a p√°gina √© carregada
    window.addEventListener('load', function () { iniciar(); });
  </script>
</body>

</html>